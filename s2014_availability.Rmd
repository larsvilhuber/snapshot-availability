---
title: "Snapshot S2014 availability"
author: "Lars Vilhuber"
output:
  html_document:
    toc: yes
    toc_depth: 1
  pdf_document:
    keep_tex: yes
    toc: yes
    toc_depth: 1
---

Users of the LEHD data in the Federal Statistical Research Data Centers (FSRDC) can only access data from states that have granted  non-Census researchers access to the data. There are, in short, two options that a state can choose: the state can delegate the approval process to the Census Bureau, which will grant access to qualified researchers on qualified research projects (option A); or it can itself review and approve projects that are submitted through the FSRDC project system (option B). Thus, researchers will automatically get access to states with option A if their project is approved by the Census Bureau, and may later obtain access to states' data that chose option B. 


```{r options, echo=FALSE,warning=FALSE,message=FALSE}
library(gdata)
library(knitr)
library(ggplot2)
xlsloc <- "."
xlsversion <- "12-10-2015"
xlsversion1 <- "020108"
```
```{r qwi_options, warning=FALSE,message=FALSE,echo=FALSE}
# version of MOU we are interested in
mouversion <- 2
mouoption    <- "A" 
# this could also be "http://download.vrdc.cornell.edu/qwipu/"
urlbase <- "http://lehd.ces.census.gov/pub/"
# this could also be "latest_release"
# qwivintage <- "R2015Q3"
qwistates <- "AK AL AR AZ CA CO CT DC DE FL GA HI IA ID IL IN KS KY LA MA MD ME MI MN MO MS MT NC ND NE NH NJ NM NV NY OH OK OR PA RI SC SD TN TX UT VA VT WA WI WV WY"
qwistates <- unlist(strsplit(qwistates," "))
```

We obtained a list of the state of the MOUs as of 

> **`r xlsversion`.** 

There are still a few states at this time that have an older form of the MOU, and for which we cannot easily deduce the option chosen. Here, we will use the later versions (version `r mouversion`) that have selected "Option `r mouoption`".

```{r readdata, echo=FALSE}
mous <- read.xls(paste(xlsloc,"/","lehd_mou_",xlsversion,".xlsx",sep=""),sheet = 1)
# replace NAs and blanks by "NA" for Options
mous <- mous[mous$fips != 66,]
newlevels <- levels(mous$Option)
newlevels[4] <- "NA"
levels(mous$Option) <- newlevels
mous[is.na(mous$Option),"Option"] <- "NA"
mous[mous$Option=="","Option"] <- "NA"
# old mous
oldmous <- read.xls(paste(xlsloc,"/","ResearchAccess_",xlsversion1,".xls",sep=""),sheet = 1)
oldmous$OldOption <- "B"
oldmous[oldmous$X2007.Response=="Yes","OldOption"] <- "A"
oldmous[oldmous$X2008.Reponse=="Yes","OldOption"] <- "A"
# merge the mou data
allmous <- merge(mous,oldmous,by.x="Name",by.y="State",all.x = TRUE)
allmous <- allmous[,c("fips","Abbr","Name","Version","Option","OldOption")]
```

Of the `r nrow(mous)` states with a MOU on file as of `r xlsversion` with the Census Bureau, `r nrow(mous[mous$Option==mouoption & is.na(mous$Option)==FALSE,])` have chosen Option `r mouoption`:
```{r tabulate_options, echo=FALSE}
#kable(table(mous$Option,useNA = "ifany"))
mous.table <- as.data.frame(table(mous$Option))
mous.table <- mous.table[mous.table$Freq != 0,]
names(mous.table)[1] <- "Option"
kable(mous.table,row.names = FALSE)
```

# Missing Completely at Random
While the number of states that have not agreed to Option `r mouoption` may seem small, from a statistical point of view, they have one important feature: the decision to participate ($M$) is (most likely) not correlated with any observable characteristic ($Y$) of the non-participating state (Statistical Analysis with Missing Data, 2nd edition, Roderick J. A. Little and Donald B. Rubin, New York: John Wiley & Sons, 2002):

> $p(M | Y, \theta, \psi) = p(M|\psi)$

where $\theta$ are parameters associated with the data generating process, and $\psi$ are parameters associated with the decision to participate in Option `r mouoption`. 

# Comparing sets of states
To assess the claim, we are going to use public-use QWI data, drawn from `r urlbase`, to assess how comparable the set of states having chosen Option `r mouoption` are, compared to the remaining states, based on a variety of variables available.

> Users who wish to consider a different variable should feel free to clone this git repository, and change parameters of interest.

# Parameters

```{r qwi_parameters}
# common quarter to look at
# this could be deduced from metadata, here we hard-code it
qwivintage <- "latest_release"
qwiyear    <- 2014
qwiquarter <- 1
# Read the version file
version.url <- url(paste(urlbase,"ak",qwivintage,"DVD-sa_f","version_sa_f.txt",sep="/"))
version <- read.csv(version.url,header = FALSE,sep = "",as.is = TRUE)
names(version) <- c("type","state","fips","range","schema","release","vintage")
write.csv(x = version[,c("type","schema","release")],file="metadata.csv")
```

# Some Technical Stuff

We first define (source) a function to download QWI CSV files.
```{r define_function}
download.date <- Sys.Date()
source("download_qwi.R",echo = TRUE)
```
We then cycle through all the states and download the relevant file. 
```{r download_all,cache=TRUE}
time.qwi <- system.time(for (x in qwistates) { 
  eval(parse(text=paste("qwi_",tolower(x)," <- download_qwi(\"",x,"\")",sep = "")))
  })
```
The above code can take a while, in this example and on my computer, it ran for `r round(time.qwi[1]/60,0)` minutes.

Now that we have the files, we collate them all into a single file:
```{r collate_states,cache=TRUE}
for (x in qwistates) { eval(parse(text=paste("qwi_",tolower(x),"$state = \"",x,"\"",sep = "")))}
for (x in qwistates[1]) { eval(parse(text=paste("all <- qwi_",tolower(x),sep = "")))}
for (x in qwistates[-1]) { eval(parse(text=paste("all <- rbind(all,qwi_",tolower(x),")",sep = "")))}
```
and merge on the indicators for MOU status:
```{r merge_mou}
allmous <- merge(all,mous,by.x="geography",by.y = "fips",all.x = TRUE)
size <- allmous[allmous$ind_level=="A",]
industry <- allmous[allmous$industry != "00",]
save(industry,file="industry.Rdata")
```

> Users who want to consider different variables might change the following option:

```{r setvar,echo=TRUE}
qwi_names=names(industry)[17:48]
usevar <- qwi_names[1]
```
# Results

The following results were based on data downloaded on `r download.date`, at which point at least one of the downloaded states was from release `r version$release` (we downloaded from `r qwivintage`). 

The industry distribution of **`r usevar`** by chosen option thus looks like this:
```{r graph_Emp,echo=FALSE}

# get industry distribution

sumvar <- paste("sum",usevar,sep = "")
grpsums <- aggregate(industry[,usevar], list(Option=industry$Option),FUN=sum, na.rm=TRUE)
names(grpsums)[2] <- sumvar
gindustry <- merge(industry,grpsums)
gindustry$pctvar <- gindustry[,usevar] / gindustry[,sumvar]

# now plot the whole thing
gg <-ggplot(data=gindustry,aes(industry,weight=pctvar,fill=Option)) +geom_bar(position="dodge",alpha=.5) +
  ylab(paste("Distribution of ",usevar,sep="")) + 
  xlab("NAICS sector") + 
  scale_fill_brewer(type="qual", palette = "Dark2")
gg <- gg +   theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.major.x = element_line(colour="black"),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())
gg

```

> Users who want to consider different variables might change the following option:

```{r,echo=FALSE}
usevar <- "SepBeg"
```

For the industry distribution of **`r usevar`**, the distribution looks like this:
```{r graph_SepBeg,echo=FALSE,ref.label="graph_Emp"}
```

```{r,echo=FALSE}
usevar <- "Payroll"
```

For the industry distribution of **`r usevar`**, the distribution looks like this:
```{r graph_Payroll,echo=FALSE,ref.label="graph_Emp"}
```

Additional variables (see the [http://lehd.ces.census.gov/data/schema/V4.0.4/lehd_public_use_schema.html](LEHD Schema) for names) can be easily added to the Rmd source file.

# Appendix: Full list of state MOUs and option chosen as of `r xlsversion`
```{r printdata,echo=FALSE}
allmous.print <- mous
#allmous.print$OldOption <- ifelse(allmous.print$Version == 1 & allmous.print$Option =="NA",allmous.print$OldOption,"")
kable(allmous.print[,c("fips","Abbr","Name","Option")])
```
